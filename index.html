<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COPD Clinical Assessment System</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\":\"COPD Clinical Assessment\",
        \"short_name\":\"COPD Assess\",
        \"start_url\":\".\",
        \"display\":\"standalone\",
        \"background_color\":\"#0f172a\",
        \"theme_color\":\"#0f172a\",
        \"icons\":[{
            \"src\":\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 96 96' fill='none'%3E%3Cpath d='M24 56 C24 32 38 24 46 30 V66 C46 74 38 82 28 82 C24 82 24 76 24 70 Z' stroke='%230ea5e9' stroke-width='4'/%3E%3Cpath d='M72 56 C72 32 58 24 50 30 V66 C50 74 58 82 68 82 C72 82 72 76 72 70 Z' stroke='%230ea5e9' stroke-width='4'/%3E%3Cline x1='48' y1='16' x2='48' y2='66' stroke='%230ea5e9' stroke-width='4'/%3E%3Crect x='42' y='22' width='12' height='26' rx='2' fill='%230ea5e9'/%3E%3Crect x='40' y='16' width='16' height='6' rx='2' fill='%230ea5e9'/%3E%3Cpath d='M40 34 Q48 42 56 34' stroke='%230ea5e9' stroke-width='3'/%3E%3Cpath d='M48 46 C42 44 38 40 36 36' stroke='%230ea5e9' stroke-width='3'/%3E%3Cpath d='M48 46 C54 44 58 40 60 36' stroke='%230ea5e9' stroke-width='3'/%3E%3C/svg%3E\",
            \"sizes\":\"192x192\",
            \"type\":\"image/svg+xml\"
        }]
    }">
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        :root {
            /* Professional Clinical Colors */
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --critical: #dc2626;
            
            /* UI Colors */
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            
            /* Spacing */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            padding: var(--space-sm);
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
        }
        
        .logo {
            width: 40px;
            height: 40px;
            margin: 0 auto var(--space-sm);
            color: var(--primary);
        }
        
        .logo svg {
            width: 100%;
            height: 100%;
        }
        
        h1 {
            font-size: 1.75rem;
            color: var(--primary);
            margin-bottom: var(--space-xs);
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Progress */
        .progress {
            display: flex;
            justify-content: space-between;
            margin: var(--space-lg) auto;
            max-width: 500px;
            position: relative;
        }
        
        .progress::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--secondary);
            z-index: 1;
        }
        
        .step {
            text-align: center;
            position: relative;
            z-index: 2;
        }
        
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-xs);
            font-size: 0.9rem;
        }
        
        .step-circle.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .step-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border-left: 4px solid var(--primary);
        }
        
        .card-title {
            font-size: 1.2rem;
            margin-bottom: var(--space-md);
            color: var(--text-primary);
        }
        
        /* Questions */
        .question-group {
            margin-bottom: var(--space-lg);
        }
        
        .question-text {
            font-size: 1.1rem;
            margin-bottom: var(--space-md);
            color: var(--text-primary);
        }
        
        /* Options */
        .option {
            display: flex;
            align-items: flex-start;
            padding: var(--space-md);
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: var(--space-sm);
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .option.selected {
            border-color: var(--primary);
            background: rgba(14, 165, 233, 0.1);
        }
        
        .option input {
            margin-right: var(--space-sm);
            margin-top: 4px;
        }
        
        .option-content {
            flex: 1;
        }
        
        .option-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .option-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Sliders */
        .slider-container {
            margin: var(--space-lg) 0;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-sm);
        }
        
        .slider-value {
            font-weight: 600;
            color: var(--primary);
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
            border-radius: 4px;
            -webkit-appearance: none;
        }
        
        /* Results */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
            margin: var(--space-lg) 0;
        }
        
        .result-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: var(--space-md);
            text-align: center;
        }
        
        .result-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
        }
        
        .result-value {
            font-size: 2rem;
            font-weight: 700;
            margin: var(--space-sm) 0;
        }
        
        /* Buttons */
        .btn {
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--secondary);
            color: var(--text-primary);
        }
        
        .btn-group {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: var(--space-xs);
            }
            
            .card {
                padding: var(--space-md);
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96" fill="none">
                    <path d="M24 56 C24 32 38 24 46 30 V66 C46 74 38 82 28 82 C24 82 24 76 24 70 Z" stroke="currentColor" stroke-width="4"/>
                    <path d="M72 56 C72 32 58 24 50 30 V66 C50 74 58 82 68 82 C72 82 72 76 72 70 Z" stroke="currentColor" stroke-width="4"/>
                    <line x1="48" y1="16" x2="48" y2="66" stroke="currentColor" stroke-width="4"/>
                    <rect x="42" y="22" width="12" height="26" rx="2" fill="currentColor"/>
                    <rect x="40" y="16" width="16" height="6" rx="2" fill="currentColor"/>
                    <path d="M40 34 Q48 42 56 34" stroke="currentColor" stroke-width="3"/>
                    <path d="M48 46 C42 44 38 40 36 36" stroke="currentColor" stroke-width="3"/>
                    <path d="M48 46 C54 44 58 40 60 36" stroke="currentColor" stroke-width="3"/>
                </svg>
            </div>
            <h1>COPD Clinical Assessment</h1>
            <p class="subtitle">mMRC • CAT • GesEPOC Integration</p>
            
            <!-- Progress -->
            <div class="progress">
                <div class="step">
                    <div class="step-circle active">1</div>
                    <div class="step-label active">mMRC</div>
                </div>
                <div class="step">
                    <div class="step-circle">2</div>
                    <div class="step-label">CAT</div>
                </div>
                <div class="step">
                    <div class="step-circle">3</div>
                    <div class="step-label">Control</div>
                </div>
                <div class="step">
                    <div class="step-circle">4</div>
                    <div class="step-label">Results</div>
                </div>
            </div>
        </header>

        <!-- Assessment Steps -->
        <div id="assessment-container">
            <!-- Step 1: mMRC -->
            <div class="card" id="step-mMRC">
                <h2 class="card-title">mMRC Dyspnea Scale</h2>
                <div class="question-group">
                    <p class="question-text">Select breathlessness severity:</p>
                    <div id="mmrc-options"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="btn-next-mMRC">Continue</button>
                </div>
            </div>

            <!-- Step 2: CAT -->
            <div class="card" id="step-CAT" style="display: none;">
                <h2 class="card-title">COPD Assessment Test</h2>
                <div id="cat-questions"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="btn-prev-CAT">Back</button>
                    <button class="btn btn-primary" id="btn-next-CAT">Continue</button>
                </div>
            </div>

            <!-- Step 3: Clinical Control -->
            <div class="card" id="step-control" style="display: none;">
                <h2 class="card-title">Clinical Control Assessment</h2>
                <div id="control-questions"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="btn-prev-control">Back</button>
                    <button class="btn btn-primary" id="btn-next-control">View Results</button>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div class="card" id="step-results" style="display: none;">
                <h2 class="card-title">Assessment Results</h2>
                
                <div class="results-grid">
                    <div class="result-card" id="result-mMRC">
                        <div class="result-label">mMRC Grade</div>
                        <div class="result-value" id="mmrc-value">-</div>
                        <div class="result-label" id="mmrc-interpretation"></div>
                    </div>
                    <div class="result-card" id="result-CAT">
                        <div class="result-label">CAT Score</div>
                        <div class="result-value" id="cat-value">-</div>
                        <div class="result-label" id="cat-interpretation"></div>
                    </div>
                    <div class="result-card" id="result-control">
                        <div class="result-label">Clinical Control</div>
                        <div class="result-value" id="control-value">-</div>
                        <div class="result-label" id="control-interpretation"></div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" id="btn-restart">New Assessment</button>
                    <button class="btn btn-primary" id="btn-print">Print Results</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ENHANCED CLINICAL ALGORITHMS
        // ============================================
        
        class COPDClinicalAssessment {
            constructor() {
                this.currentStep = 1;
                this.data = {
                    mMRC: null,
                    CAT: {},
                    control: {}
                };
                
                this.initialize();
            }
            
            // ===== VALIDATED CLINICAL ALGORITHMS =====
            
            calculateCATScore() {
                // Validated CAT scoring algorithm
                const scores = Object.values(this.data.CAT);
                if (scores.length !== 8) return null;
                
                const total = scores.reduce((a, b) => a + b, 0);
                
                // Clinical validation: each item 0-4
                if (scores.some(s => s < 0 || s > 4)) {
                    console.error('Invalid CAT score detected');
                    return null;
                }
                
                return total;
            }
            
            interpretCAT(score) {
                // GOLD 2023 CAT interpretation
                if (score === null) return { level: 'Not assessed', severity: 'unknown' };
                
                if (score <= 10) return { 
                    level: 'Low Impact', 
                    severity: 'mild',
                    color: 'var(--success)',
                    clinicalImplication: 'Minimal symptom burden'
                };
                if (score <= 20) return { 
                    level: 'Medium Impact', 
                    severity: 'moderate',
                    color: 'var(--warning)',
                    clinicalImplication: 'Moderate symptom burden'
                };
                if (score <= 30) return { 
                    level: 'High Impact', 
                    severity: 'severe',
                    color: 'var(--danger)',
                    clinicalImplication: 'High symptom burden'
                };
                return { 
                    level: 'Very High Impact', 
                    severity: 'very severe',
                    color: 'var(--critical)',
                    clinicalImplication: 'Very high symptom burden'
                };
            }
            
            interpretMMRC(grade) {
                // Standard mMRC interpretation
                const interpretations = {
                    0: { level: 'Grade 0', severity: 'none', color: 'var(--success)' },
                    1: { level: 'Grade 1', severity: 'mild', color: 'var(--success)' },
                    2: { level: 'Grade 2', severity: 'moderate', color: 'var(--warning)' },
                    3: { level: 'Grade 3', severity: 'severe', color: 'var(--danger)' },
                    4: { level: 'Grade 4', severity: 'very severe', color: 'var(--critical)' }
                };
                return interpretations[grade] || { level: 'Not assessed', severity: 'unknown' };
            }
            
            calculateClinicalControl() {
                // Enhanced GesEPOC algorithm
                const unfavorableCriteria = [];
                
                // 1. Clinical stability
                if (this.data.control.stability === 'worse') {
                    unfavorableCriteria.push('clinical_worsening');
                }
                
                // 2. Exacerbations
                if (this.data.control.exacerbations === 'yes') {
                    unfavorableCriteria.push('recent_exacerbation');
                }
                
                // 3. Sputum color
                if (this.data.control.sputum === 'colored') {
                    unfavorableCriteria.push('purulent_sputum');
                }
                
                // 4. Rescue medication use
                if (this.data.control.rescue === 'high') {
                    unfavorableCriteria.push('high_rescue_use');
                }
                
                // 5. Physical activity
                if (this.data.control.activity === 'low') {
                    unfavorableCriteria.push('low_activity');
                }
                
                // 6. Lung function
                if (this.data.control.fev1 === '<50') {
                    unfavorableCriteria.push('low_fev1');
                }
                
                // 7. mMRC ≥ 2 is unfavorable
                if (this.data.mMRC >= 2) {
                    unfavorableCriteria.push('dyspnea_mmrc2');
                }
                
                // 8. CAT ≥ 20 is unfavorable
                const catScore = this.calculateCATScore();
                if (catScore >= 20) {
                    unfavorableCriteria.push('high_cat_score');
                }
                
                const unfavorableCount = unfavorableCriteria.length;
                const isStable = this.data.control.stability !== 'worse' && 
                                this.data.control.exacerbations === 'no';
                
                // GesEPOC 2023 classification
                if (isStable && unfavorableCount <= 2) {
                    return {
                        status: 'Controlled',
                        class: 'A',
                        color: 'var(--success)',
                        criteria: unfavorableCriteria,
                        recommendations: [
                            'Continue current therapy',
                            'Annual review',
                            'Maintain vaccination status'
                        ]
                    };
                } else if (!isStable && unfavorableCount <= 2) {
                    return {
                        status: 'Partially Controlled',
                        class: 'B',
                        color: 'var(--warning)',
                        criteria: unfavorableCriteria,
                        recommendations: [
                            'Review therapy adherence',
                            'Consider LAMA/LABA combination',
                            'Follow-up in 3 months'
                        ]
                    };
                } else if (isStable && unfavorableCount >= 3) {
                    return {
                        status: 'Poorly Controlled',
                        class: 'C',
                        color: 'var(--danger)',
                        criteria: unfavorableCriteria,
                        recommendations: [
                            'Optimize bronchodilator therapy',
                            'Consider triple therapy',
                            'Pulmonary rehab referral',
                            'Close monitoring needed'
                        ]
                    };
                } else {
                    return {
                        status: 'Uncontrolled',
                        class: 'D',
                        color: 'var(--critical)',
                        criteria: unfavorableCriteria,
                        recommendations: [
                            'Urgent clinical review',
                            'Consider ICS addition',
                            'Exacerbation management plan',
                            'Frequent follow-up'
                        ]
                    };
                }
            }
            
            // ===== RISK STRATIFICATION =====
            
            calculateExacerbationRisk() {
                // Modified BODEX-like scoring
                let score = 0;
                
                // mMRC ≥ 2: +1 point
                if (this.data.mMRC >= 2) score += 1;
                
                // CAT ≥ 20: +1 point
                const catScore = this.calculateCATScore();
                if (catScore >= 20) score += 1;
                
                // Recent exacerbation: +2 points
                if (this.data.control.exacerbations === 'yes') score += 2;
                
                // Low FEV1: +1 point
                if (this.data.control.fev1 === '<50') score += 1;
                
                // Risk categories
                if (score <= 1) return 'Low Risk';
                if (score <= 3) return 'Moderate Risk';
                return 'High Risk';
            }
            
            generateClinicalSummary() {
                const mMRC = this.interpretMMRC(this.data.mMRC);
                const catScore = this.calculateCATScore();
                const cat = this.interpretCAT(catScore);
                const control = this.calculateClinicalControl();
                const risk = this.calculateExacerbationRisk();
                
                return {
                    timestamp: new Date().toISOString(),
                    scores: {
                        mMRC: this.data.mMRC,
                        CAT: catScore,
                        control: control.class
                    },
                    interpretations: {
                        mMRC: mMRC.level,
                        CAT: cat.level,
                        control: control.status
                    },
                    riskAssessment: risk,
                    unfavorableCriteria: control.criteria,
                    recommendations: control.recommendations,
                    clinicalPriority: this.determinePriority(mMRC, cat, control, risk)
                };
            }
            
            determinePriority(mMRC, cat, control, risk) {
                // Clinical triage priority
                if (control.class === 'D' || this.data.mMRC === 4 || risk === 'High Risk') {
                    return 'High Priority - Urgent Review';
                }
                if (control.class === 'C' || this.data.mMRC === 3 || cat.severity === 'severe') {
                    return 'Medium Priority - Review Soon';
                }
                return 'Routine Follow-up';
            }
            
            // ===== DATA VALIDATION =====
            
            validateAssessment() {
                const errors = [];
                
                if (this.data.mMRC === null) errors.push('mMRC not completed');
                
                const catItems = Object.keys(this.data.CAT).length;
                if (catItems !== 8) errors.push(`CAT incomplete: ${catItems}/8 items`);
                
                const requiredControls = ['stability', 'exacerbations', 'sputum', 'rescue', 'activity', 'fev1'];
                const missingControls = requiredControls.filter(key => !this.data.control[key]);
                if (missingControls.length > 0) {
                    errors.push(`Clinical assessment incomplete: ${missingControls.join(', ')}`);
                }
                
                return {
                    isValid: errors.length === 0,
                    errors
                };
            }
            
            // ===== UI RENDERING =====
            
            initialize() {
                this.renderMMRC();
                this.renderCAT();
                this.renderControl();
                this.setupEventListeners();
                this.updateProgress();
            }
            
            renderMMRC() {
                const options = [
                    { value: 0, title: 'Grade 0', desc: 'Not troubled except with strenuous exercise' },
                    { value: 1, title: 'Grade 1', desc: 'Troubled when hurrying or walking up slight hill' },
                    { value: 2, title: 'Grade 2', desc: 'Walks slower than peers, stops for breath' },
                    { value: 3, title: 'Grade 3', desc: 'Stops after 100m or few minutes walking' },
                    { value: 4, title: 'Grade 4', desc: 'Too breathless to leave house' }
                ];
                
                const container = document.getElementById('mmrc-options');
                container.innerHTML = options.map(opt => `
                    <div class="option ${this.data.mMRC === opt.value ? 'selected' : ''}" 
                         onclick="app.selectMMRC(${opt.value})">
                        <input type="radio" name="mmrc" value="${opt.value}" 
                               ${this.data.mMRC === opt.value ? 'checked' : ''}>
                        <div class="option-content">
                            <div class="option-title">${opt.title}</div>
                            <div class="option-desc">${opt.desc}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            renderCAT() {
                const questions = [
                    { id: 1, text: 'Cough frequency', min: 'Never', max: 'Always' },
                    { id: 2, text: 'Phlegm production', min: 'None', max: 'Large amount' },
                    { id: 3, text: 'Chest tightness', min: 'Not tight', max: 'Very tight' },
                    { id: 4, text: 'Breathlessness on stairs', min: 'None', max: 'Severe' },
                    { id: 5, text: 'Activity limitation', min: 'Not limited', max: 'Very limited' },
                    { id: 6, text: 'Confidence leaving home', min: 'Very confident', max: 'Not confident' },
                    { id: 7, text: 'Sleep quality', min: 'Soundly', max: 'Poorly' },
                    { id: 8, text: 'Energy level', min: 'Lots of energy', max: 'No energy' }
                ];
                
                const container = document.getElementById('cat-questions');
                container.innerHTML = questions.map(q => `
                    <div class="slider-container" data-id="${q.id}">
                        <div class="slider-header">
                            <span>${q.text}</span>
                            <span class="slider-value">${this.data.CAT[q.id] || 0}</span>
                        </div>
                        <input type="range" min="0" max="4" value="${this.data.CAT[q.id] || 0}" 
                               oninput="app.updateCAT(${q.id}, this.value)">
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary);">
                            <span>${q.min}</span>
                            <span>${q.max}</span>
                        </div>
                    </div>
                `).join('');
            }
            
            renderControl() {
                const questions = [
                    { id: 'stability', text: 'Clinical stability since last visit', 
                      options: [
                        { value: 'better', label: 'Better' },
                        { value: 'same', label: 'Similar/Stable' },
                        { value: 'worse', label: 'Worse' }
                      ] },
                    { id: 'exacerbations', text: 'Exacerbations in last 3 months',
                      options: [
                        { value: 'no', label: 'No exacerbations' },
                        { value: 'yes', label: 'One or more exacerbations' }
                      ] },
                    { id: 'sputum', text: 'Sputum characteristics',
                      options: [
                        { value: 'clear', label: 'Clear/No sputum' },
                        { value: 'colored', label: 'Colored/Yellow/Green' }
                      ] },
                    { id: 'rescue', text: 'Rescue medication use',
                      options: [
                        { value: 'low', label: '< 3 times per week' },
                        { value: 'high', label: '≥ 3 times per week' }
                      ] },
                    { id: 'activity', text: 'Daily physical activity',
                      options: [
                        { value: 'adequate', label: '≥ 30 minutes daily' },
                        { value: 'low', label: '< 30 minutes daily' }
                      ] },
                    { id: 'fev1', text: 'FEV₁ (% predicted)',
                      options: [
                        { value: '>=50', label: '≥ 50%' },
                        { value: '<50', label: '< 50%' },
                        { value: 'unknown', label: 'Unknown' }
                      ] }
                ];
                
                const container = document.getElementById('control-questions');
                container.innerHTML = questions.map(q => `
                    <div class="question-group">
                        <p class="question-text">${q.text}</p>
                        <div class="options">
                            ${q.options.map(opt => `
                                <div class="option ${this.data.control[q.id] === opt.value ? 'selected' : ''}"
                                     onclick="app.selectControl('${q.id}', '${opt.value}')">
                                    <input type="radio" name="${q.id}" value="${opt.value}"
                                           ${this.data.control[q.id] === opt.value ? 'checked' : ''}>
                                    <div class="option-content">
                                        <div class="option-title">${opt.label}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
            
            // ===== UI INTERACTIONS =====
            
            selectMMRC(value) {
                this.data.mMRC = value;
                this.renderMMRC();
                this.updateProgress();
            }
            
            updateCAT(id, value) {
                this.data.CAT[id] = parseInt(value);
                document.querySelector(`[data-id="${id}"] .slider-value`).textContent = value;
            }
            
            selectControl(question, value) {
                this.data.control[question] = value;
                this.renderControl();
            }
            
            nextStep() {
                if (this.currentStep === 4) return;
                
                // Validate current step
                let isValid = true;
                if (this.currentStep === 1 && this.data.mMRC === null) {
                    alert('Please select mMRC grade');
                    isValid = false;
                }
                
                if (isValid) {
                    this.hideAllSteps();
                    this.currentStep++;
                    this.showStep(this.currentStep);
                    this.updateProgress();
                    
                    if (this.currentStep === 4) {
                        this.displayResults();
                    }
                }
            }
            
            prevStep() {
                if (this.currentStep === 1) return;
                this.hideAllSteps();
                this.currentStep--;
                this.showStep(this.currentStep);
                this.updateProgress();
            }
            
            hideAllSteps() {
                ['mMRC', 'CAT', 'control', 'results'].forEach(id => {
                    document.getElementById(`step-${id}`).style.display = 'none';
                });
            }
            
            showStep(step) {
                const steps = { 1: 'mMRC', 2: 'CAT', 3: 'control', 4: 'results' };
                document.getElementById(`step-${steps[step]}`).style.display = 'block';
            }
            
            updateProgress() {
                document.querySelectorAll('.step-circle').forEach((circle, index) => {
                    circle.classList.remove('active');
                    if (index + 1 < this.currentStep) {
                        circle.classList.add('completed');
                    } else if (index + 1 === this.currentStep) {
                        circle.classList.add('active');
                    }
                });
            }
            
            displayResults() {
                // Calculate and display results
                const validation = this.validateAssessment();
                if (!validation.isValid) {
                    alert('Please complete all assessments: ' + validation.errors.join(', '));
                    return;
                }
                
                const mMRC = this.interpretMMRC(this.data.mMRC);
                const catScore = this.calculateCATScore();
                const cat = this.interpretCAT(catScore);
                const control = this.calculateClinicalControl();
                
                // Update UI
                document.getElementById('mmrc-value').textContent = `Grade ${this.data.mMRC}`;
                document.getElementById('mmrc-interpretation').textContent = mMRC.level;
                document.getElementById('mmrc-interpretation').style.color = mMRC.color;
                
                document.getElementById('cat-value').textContent = catScore;
                document.getElementById('cat-interpretation').textContent = cat.level;
                document.getElementById('cat-interpretation').style.color = cat.color;
                
                document.getElementById('control-value').textContent = control.status;
                document.getElementById('control-interpretation').textContent = `Class ${control.class}`;
                document.getElementById('control-interpretation').style.color = control.color;
            }
            
            restart() {
                if (confirm('Start new assessment?')) {
                    this.currentStep = 1;
                    this.data = { mMRC: null, CAT: {}, control: {} };
                    this.hideAllSteps();
                    this.showStep(1);
                    this.renderMMRC();
                    this.renderCAT();
                    this.renderControl();
                    this.updateProgress();
                }
            }
            
            printResults() {
                const summary = this.generateClinicalSummary();
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                    <head><title>COPD Assessment Results</title>
                    <style>
                        body { font-family: Arial; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .scores { display: flex; gap: 20px; margin: 20px 0; }
                        .score-box { border: 1px solid #ccc; padding: 15px; flex: 1; text-align: center; }
                        .recommendations { margin-top: 30px; }
                        .footer { margin-top: 50px; font-size: 12px; color: #666; }
                    </style>
                    </head>
                    <body>
                        <div class="header">
                            <h2>COPD Clinical Assessment Results</h2>
                            <p>${new Date().toLocaleDateString()}</p>
                        </div>
                        <div class="scores">
                            <div class="score-box">
                                <h3>mMRC</h3>
                                <p>Grade ${summary.scores.mMRC}</p>
                                <p>${summary.interpretations.mMRC}</p>
                            </div>
                            <div class="score-box">
                                <h3>CAT Score</h3>
                                <p>${summary.scores.CAT}/40</p>
                                <p>${summary.interpretations.CAT}</p>
                            </div>
                            <div class="score-box">
                                <h3>Clinical Control</h3>
                                <p>${summary.interpretations.control}</p>
                                <p>Class ${summary.scores.control}</p>
                            </div>
                        </div>
                        <div class="recommendations">
                            <h3>Clinical Summary</h3>
                            <p><strong>Risk Assessment:</strong> ${summary.riskAssessment}</p>
                            <p><strong>Clinical Priority:</strong> ${summary.clinicalPriority}</p>
                            <h4>Recommendations:</h4>
                            <ul>
                                ${summary.recommendations.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="footer">
                            <p>Generated by COPD Clinical Assessment System</p>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }
            
            setupEventListeners() {
                // Navigation
                document.getElementById('btn-next-mMRC').onclick = () => this.nextStep();
                document.getElementById('btn-next-CAT').onclick = () => this.nextStep();
                document.getElementById('btn-next-control').onclick = () => this.nextStep();
                
                document.getElementById('btn-prev-CAT').onclick = () => this.prevStep();
                document.getElementById('btn-prev-control').onclick = () => this.prevStep();
                
                // Actions
                document.getElementById('btn-restart').onclick = () => this.restart();
                document.getElementById('btn-print').onclick = () => this.printResults();
            }
        }

        // Initialize application
        const app = new COPDClinicalAssessment();
        window.app = app;
    </script>
</body>
</html>
